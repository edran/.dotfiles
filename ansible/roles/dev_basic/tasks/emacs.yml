---
- name: Emacs | Check current installation
  command: "emacs-{{emacs_version}} --version"
  ignore_errors: yes
  register: emacs_present
  changed_when: emacs_present.rc > 0

- name: Emacs | Install build-essential
  become: yes
  become_method: sudo
  package:
    name: build-essential
    state: present
  when: emacs_present|failed

- name: Emacs | Install build deps
  become: yes
  become_method: sudo
  apt:
    pkg: emacs24
    state: build-dep
  when: emacs_present|failed

- name: Emacs | Download source
  get_url:
    url: "http://ftp.heanet.ie/mirrors/gnu/emacs/emacs-{{emacs_version}}.tar.gz"
    dest: "/tmp/emacs-{{emacs_version}}.tar.gz"
  when: emacs_present|failed

- name: Emacs | Untar source
  become: yes
  become_method: sudo
  unarchive:
    copy: no
    src: "/tmp/emacs-{{emacs_version}}.tar.gz"
    dest: "/opt"
    creates: "/opt/emacs-{{emacs_version}}"
  when: emacs_present|failed

- name: Emacs | Configure source
  become: yes
  become_method: sudo
  command: ./configure
  args:
    chdir: "/opt/emacs-{{emacs_version}}"
  when: emacs_present|failed

- name: Emacs | Build source
  become: yes
  become_method: sudo
  command: make
  args:
    chdir: "/opt/emacs-{{emacs_version}}"
    creates: "/opt/emacs-{{emacs_version}}/src/emacs"
  when: emacs_present|failed

- name: Emacs | Install emacs
  become: yes
  become_method: sudo
  command: make install
  args:
    chdir: "/opt/emacs-{{emacs_version}}"
    creates: "/usr/local/bin/emacs"
  when: emacs_present|failed

- name: Emacs | Check .emacs.d
  stat:
    path: "{{ ansible_env.HOME }}/.emacs.d"
  register: emacs_path

- name: Emacs | Download Spacemacs 
  git:
    repo: https://github.com/syl20bnr/spacemacs
    dest: "{{ ansible_env.HOME }}/.emacs.d"
    accept_hostkey: yes
    recursive: yes
    version: develop
  when: not emacs_path.stat.exists
